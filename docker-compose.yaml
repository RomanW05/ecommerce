version: "3.8"

x-zoo: &zoo "kafka-1:2888:3888;kafka-2:2888:3888;kafka-3:2888:3888"
x-kafkaZookeepers: &kafkaZookeepers "kafka-1:2181,kafka-2:2181,kafka-3:2181"
x-kafkaBrokers: &kafkaBrokers "kafka-1:9092"

services:
    # Brokers
    zookeeper:
        image: confluentinc/cp-zookeeper:7.2.6
        restart: always
        networks:
            - mynet
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - 2181:2181
        volumes:
            - ./kafka-data/zookeeper:/var/lib/zookeeper/data
            - ./kafka-data/zookeeper-logs:/var/lib/zookeeper/log
    kafka:
        image: confluentinc/cp-kafka:7.2.6
        networks:
            - mynet
        depends_on:
            - zookeeper
        ports:
            - 9092:9092
            - 29092:29092
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        volumes:
            - ./kafka-data/kafka:/var/lib/kafka/data
    
    kafdrop:
        image: obsidiandynamics/kafdrop
        restart: "no"
        ports:
            - "9000:9000"
        environment:
            KAFKA_BROKERCONNECT: "kafka:9092"
        networks:
            - mynet


    # backends
    backend_analytics:
        restart: always
        build:
            dockerfile: ./ecommerce/backend_analytics/Dockerfile
        ports:
            - "8001:8001"
        env_file:
            - .env
        environment:
            POSTGRES_USER: ${DATABASE_ANALYTICS_POSTGRES_USER}
            POSTGRES_PASSWORD: ${DATABASE_ANALYTICS_POSTGRES_PASSWORD}
            POSTGRES_DB: ${DATABASE_ANALYTICS_POSTGRES_DATABASE_NAME}
            POSTGRES_HOST: database_analytics
            POSTGRES_PORT: ${POSTGRES_PORT}
            KAFKA_BROKERCONNECT: "kafka:9092"
        networks:
            - mynet
            - database_network
        # depends_on:
        #     kafka1:
        #         condition: service_healthy

    backend_api:
        restart: always
        build:
            dockerfile: ./ecommerce/backend_api/Dockerfile
        ports:
            - "8000:8000"
        command: "python3 manage.py runserver 0.0.0.0:8000"
        volumes:
            - ./ecommerce/backend_api:/api
        networks:
            - mynet
        environment:
            KAFKA_BROKERCONNECT: "kafka:9092"


    # Databases
    database_analytics:
        build:
            dockerfile: ./ecommerce/database_analytics/Dockerfile
        restart: always
        ports:
            - '5432:${POSTGRES_PORT}'
        networks:
            - database_network
        env_file:
            - .env
        volumes:
            - ./data/database_analytics:/var/lib/database_analytics/data
        environment:
            POSTGRES_USER: ${DATABASE_ANALYTICS_POSTGRES_USER}
            POSTGRES_PASSWORD: ${DATABASE_ANALYTICS_POSTGRES_PASSWORD}
            POSTGRES_DB: ${DATABASE_ANALYTICS_POSTGRES_DATABASE_NAME}
        healthcheck:
            test: [“CMD-SHELL”, “pg_isready”]
            interval: 1s
            timeout: 5s
            retries: 10
    
    # database_users:
    #     build:
    #         dockerfile: ./ecommerce/database_users/Dockerfile
    #     restart: always
    #     ports:
    #         - '5433:${POSTGRES_PORT}'
    #     networks:
    #         - database_network
    #     env_file:
    #         - .env
    #     volumes:
    #         - ./data/database_users:/var/lib/database_users/data
    #     environment:
    #         POSTGRES_USER: ${DATABASE_USERS_POSTGRES_USER}
    #         POSTGRES_PASSWORD: ${DATABASE_USERS_POSTGRES_PASSWORD}
    #         POSTGRES_DB: ${DATABASE_USERS_POSTGRES_DATABASE_NAME}
    #     healthcheck:
    #         test: [“CMD-SHELL”, “pg_isready”]
    #         interval: 1s
    #         timeout: 5s
    #         retries: 10
    
    # database_products:
    #     build:
    #         dockerfile: ./ecommerce/database_products/Dockerfile
    #     restart: always
    #     ports:
    #         - '5434:${POSTGRES_PORT}'
    #     networks:
    #         - database_network
    #     env_file:
    #         - .env
    #     volumes:
    #         - ./data/database_products:/var/lib/database_products/data
    #     environment:
    #         POSTGRES_USER: ${DATABASE_PRODUCTS_POSTGRES_USER}
    #         POSTGRES_PASSWORD: ${DATABASE_PRODUCTS_POSTGRES_PASSWORD}
    #         POSTGRES_DB: ${DATABASE_PRODUCTS_POSTGRES_DATABASE_NAME}
    #     healthcheck:
    #         test: [“CMD-SHELL”, “pg_isready”]
    #         interval: 1s
    #         timeout: 5s
    #         retries: 10
    
    # database_marketing:
    #     build:
    #         dockerfile: ./ecommerce/database_marketing/Dockerfile
    #     restart: always
    #     ports:
    #         - '5435:${POSTGRES_PORT}'
    #     networks:
    #         - database_network
    #     env_file:
    #         - .env
    #     volumes:
    #         - ./data/database_marketing:/var/lib/database_marketing/data
    #     environment:
    #         POSTGRES_USER: ${DATABASE_MARKETING_POSTGRES_USER}
    #         POSTGRES_PASSWORD: ${DATABASE_MARKETING_POSTGRES_PASSWORD}
    #         POSTGRES_DB: ${DATABASE_MARKETING_POSTGRES_DATABASE_NAME}
    #     healthcheck:
    #         test: [“CMD-SHELL”, “pg_isready”]
    #         interval: 1s
    #         timeout: 5s
    #         retries: 10

    # database_orders:
    #     build:
    #         dockerfile: ./ecommerce/database_orders/Dockerfile
    #     restart: always
    #     ports:
    #         - '5436:${POSTGRES_PORT}'
    #     networks:
    #         - database_network
    #     env_file:
    #         - .env
    #     volumes:
    #         - ./data/database_orders:/var/lib/database_orders/data
    #     environment:
    #         POSTGRES_USER: ${DATABASE_ORDERS_POSTGRES_USER}
    #         POSTGRES_PASSWORD: ${DATABASE_ORDERS_POSTGRES_PASSWORD}
    #         POSTGRES_DB: ${DATABASE_ORDERS_POSTGRES_DATABASE_NAME}
    #     healthcheck:
    #         test: [“CMD-SHELL”, “pg_isready”]
    #         interval: 1s
    #         timeout: 5s
    #         retries: 10

    
    # # Database administrator
    pgadmin:
        image: dpage/pgadmin4
        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
            PGADMIN_LISTEN_PORT: ${PGADMIN_LISTEN_PORT}
            PGADMIN_CONFIG_SERVER_MODE: ${PGADMIN_CONFIG_SERVER_MODE}
        ports:
            - "5050:${PGADMIN_LISTEN_PORT}"
        volumes:
            - ./data/pgadmin4:/var/lib/pgadmin4/data
        networks:
            - database_network
        restart: unless-stopped

    
networks:
    database_network:
        driver: bridge
    mynet:
        driver: bridge

volumes:
    zookeeper: {}
    kafka1: {}
    database_analytics: {}
    database_marketing: {}
    database_orders: {}
    database_products: {}
    database_users: {}
    pgadmin: {}
